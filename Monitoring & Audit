CloudWatch Metrics

 - CloudWatch provides metrics for every AWS service
 - Metric is a variable to monitor (CPU util, Networking, etc..)
 - Metrics belong to namespaces
 - Dimension is an attribute of a metric (instance id, environment, etc..)
 - Up to 30 dimensions per metric
 - Metrics have timestamps
 - Can create CloudWatch dashboards of metrics
 - Can create CloudWatch Custom Metrics (e.g., for the RAM)

 - CloudWatch Metric Streams:
 - Continually stream CloudWatch metrics to a destination of your choice with near-real-time delivery and low latency
    1. Amazon Kinesis Data Firehose (and then its destinations)
    2. 3rd party service provider: Datadog, Dynatrace, New Relic, Splunk, Sumo logic, etc..

 - Diagram:

   CloudWatch Metrics ---(stream near-real-time)---> Kinesis Data Firehose ------> Amazon S3 ------> Athena 

 - The data is stored in Amazon S3 and can then be analyzed with Athena
 - You can alternatively store your data in Amazon Redshift (data warehouse) - from Firehose
 - You can also route the data from Firehose to Amazon OpenSearch to perform analytics there
 - Option to filter metrics to only stream a subset of them

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CloudWatch Logs

 - Log groups: arbitrary name, usually representing an application that is to be monitored
 - Log stream: instances within application / log files / containers
 - Can define log expiration policies (never expire, 1 day to 10 years)
 - CloudWatch Logs can send logs to:
    1. Amazon S3 (exports)
    2. Kinesis Data Streams
    3. Kinesis Data Firehose
    4. AWS Lambda
    5. OpenSearch
 - Logs are encrypted by default
 - Can setup KMS-based encryption with your own keys

 - CloudWatch Logs - Sources:
    1. SDK
    2. CloudWatch Logs Agent
    3. CloudWatch Unified Agent
    4. Elastic Beanstalk: collection of logs from app
    5. ECS: collection from containers
    6. AWS Lambda: collection from function logs
    7. VPC Flow Logs: VPC specific logs
    8. API Gateway
    9. CloudTrail based on filter
    10. Route 53: Log DNS queries

 - CloudWatch Logs Insights (can be used to query CloudWatch Logs)
 - Search and analyze log data stored in CloudWatch Logs
 - Example: find a specific IP inside a log, count occurrences of "ERROR" in your logs
 - Provides a purpose-built query language:
    1. Automatically discovers fields from AWS services and JSON log events
    2. Fetch desired event fields, filter based on conditions, calculate aggregate statistics, sort events, limit number of events...
    3. Can save queries and add them to CloudWatch Dashboards
 - Can query multiple Log Groups in different AWS accounts
 - It's a query engine, not a real-time engine

 - CloudWatch Logs - S3 Export
 - Log data can take up to 12 hours to become available for export
 - The API call is CreateExportTask
 - Not near-real-time or real-time... use Log Subscribtions instead

 - CloudWatch Logs Subscribtions:
 - Get a real-time log events from CloudWatch Logs for processing an analysis
 - Send to Kinesis Data Streams, Kinesis Data Firehose, or Lambda
 - Subscribtion Filter - filter which logs are events delivered to your destination

 - Diagram

   CloudWatch Logs ---(logs)---> Subscribtion Filter ------> Kinesis Data Streams ------> Kinesis Data Firehose/Kinesis Data Analytics/EC2/Lambda

 - or

   CloudWatch Logs ---(logs)---> Subscribtion Filter ------> Kinesis Data Firehose ---(near-real-time)---> S3/OpenSearch

 - or

   CloudWatch Logs ---(logs)---> Subscribtion Filter ------> Lambda ---(real-time)---> OpenSearch

 - CloudWatch Logs Aggregation is possible from multiple accounts and multiple regions

 - CloudWatch Logs Subscribtions:
 - Cross-account Subscribtions - send log events to resources in a different AWS account (Data Stream, Firehose)
 - You must have a cross-account IAM role and a destination access policy

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CloudWatch Agent & CloudWatch Logs Agent

 - By default, no logs from your EC2 machine will go to CloudWatch
 - You need to run a CloudWatch agent on EC2 to push the log files you want
 - Make sure IAM permissions are correct
 - The CloudWatch log agent can be setup on-prem as well

 - CloudWatch Logs Agent & Unified Agent:
 - For virtual servers (EC2 instances, on-prem servers)
 - CloudWatch Logs Agent:
    1. Old version of the agent
    2. Can only send to CloudWatch Logs
 - CloudWatch Unified Agent:
    1. Collect additional system-level metrics such as RAM, processes, etc..
    2. Collect logs to send to CloudWatch Logs
    3. Centralized configuration using SSM Parameter Store

 - CloudWatch Unified Agent - Metrics
 - Collected directly on your Linux server / EC2 instance
 - CPU (active, guest, idle, system, user, steal)
 - Disk metrics (free, used, total), Disk IO (writes, reads, bytes, iops)
 - RAM (free, inactive, used, total, cached)
 - Netstat (number of TCP and UDP connections, net packets, bytes)
 - Processes (total, dead, bloqued, idle, running, sleep)
 - Swap Space (free, used, used%)

 - Reminder: out-of-the box metrics for EC2 - disk, CPU, network (high level)
 - For more granular logs, you need the CloudWatch Unified Agent

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

